<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üå¶Ô∏è Cinematic Weather ‚Äî Sun & Moon with Spark Trail</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Lottie -->
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
  /* ========== THEME COLORS ========== */
  :root{
    --night-1:#0b1220; --night-2:#071226;
    --sunrise-1:#ff9a8b; --sunrise-2:#ff6a88;
    --day-1:#89f7fe; --day-2:#66a6ff;
    --sunset-1:#ff9a00; --sunset-2:#ff416c;
    --card-bg: rgba(255,255,255,0.10);
    --card-bg-dark: rgba(0,0,0,0.40);
    --accent: #00b4ff;
    --text-dark:#06111a; --text-light:#f3f6fa;
  }
  [data-theme="dark"]{ --card-bg:var(--card-bg-dark); --text:var(--text-light); }
  [data-theme="light"]{ --card-bg:rgba(255,255,255,0.10); --text:var(--text-dark); }

  html,body{
    height:100%;
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    overflow:hidden;
    background: linear-gradient(180deg,var(--day-1),var(--day-2));
  }

  /* ========== SKY + CYCLE (120s) ========== */
  .sky-wrap { position:fixed; inset:0; z-index:-5; pointer-events:none; }
  .sky {
    position:absolute; inset:0;
    background: radial-gradient(circle at 10% 20%, var(--day-1), transparent 15%),
                linear-gradient(180deg, var(--day-1) 0%, var(--day-2) 100%);
    animation: skyCycle 120s linear infinite;
    will-change: background;
  }
  @keyframes skyCycle{
    0%   { background: linear-gradient(180deg,var(--night-1) 0%,var(--night-2) 80%); }
    10%  { background: linear-gradient(180deg,#0e2033,#113047); }
    25%  { background: linear-gradient(180deg,var(--sunrise-1),var(--sunrise-2)); }
    40%  { background: linear-gradient(180deg,var(--day-1),var(--day-2)); }
    70%  { background: linear-gradient(180deg,var(--day-1),var(--day-2)); }
    80%  { background: linear-gradient(180deg,var(--sunset-1),var(--sunset-2)); }
    90%  { background: linear-gradient(180deg,#1b2740,#15243a); }
    100% { background: linear-gradient(180deg,var(--night-1) 0%,var(--night-2) 80%); }
  }

  /* ========== CLOUD LAYERS + DENSITY ========== */
  .clouds { position:fixed; inset:0; z-index:-4; overflow:hidden; pointer-events:none; }
  .cloud { position:absolute; opacity:.85; filter: drop-shadow(0 8px 30px rgba(0,0,0,0.28)); will-change:transform,opacity,filter; }
  .cloud.c1{ width:900px; top:6%; left:-1100px; animation: cloudMove1 100s linear infinite, cloudDensity1 120s linear infinite; }
  .cloud.c2{ width:620px; top:28%; left:-800px; animation: cloudMove2 85s linear infinite, cloudDensity2 120s linear infinite; }
  .cloud.c3{ width:420px; top:52%; left:-650px; animation: cloudMove3 70s linear infinite, cloudDensity3 120s linear infinite; }
  .cloud.c1b{ width:820px; top:18%; left:-1400px; animation: cloudMove1 110s linear infinite, cloudDensity1 120s linear infinite; opacity:.75; }
  .cloud.c2b{ width:540px; top:44%; left:-950px; animation: cloudMove2 95s linear infinite, cloudDensity2 120s linear infinite; opacity:.7; }

  @keyframes cloudMove1 { from{transform:translateX(0);} to{transform:translateX(220vw);} }
  @keyframes cloudMove2 { from{transform:translateX(0);} to{transform:translateX(200vw);} }
  @keyframes cloudMove3 { from{transform:translateX(0);} to{transform:translateX(180vw);} }

  @keyframes cloudDensity1 {
    0%{opacity:.25; filter:blur(0px) brightness(.9) saturate(.95); transform:scale(1.02)}
    10%{opacity:.35}
    25%{opacity:.9; filter:blur(.6px) brightness(1.05) saturate(1.05)}
    40%{opacity:.45; filter:blur(0) brightness(1)}
    70%{opacity:.45}
    80%{opacity:.95; filter:blur(.6px) brightness(1.08) saturate(1.08); transform:scale(1.04)}
    90%{opacity:.45}
    100%{opacity:.25; transform:scale(1.02)}
  }
  @keyframes cloudDensity2 {
    0%{opacity:.18}
    10%{opacity:.28}
    25%{opacity:.85; filter:brightness(1.04)}
    40%{opacity:.32}
    70%{opacity:.32}
    80%{opacity:.92; filter:brightness(1.07)}
    90%{opacity:.28}
    100%{opacity:.18}
  }
  @keyframes cloudDensity3 {
    0%{opacity:.12; transform:translateY(0)}
    10%{opacity:.18}
    25%{opacity:.7}
    40%{opacity:.18}
    70%{opacity:.18}
    80%{opacity:.78; transform:translateY(-6px)}
    90%{opacity:.18; transform:translateY(0)}
    100%{opacity:.12}
  }

  /* small tint overlay applied via JS (warmth), using pseudo element would need inline imgs; we'll tint via filter/hue-rotate in JS */

  /* ========== STARS ========== */
  .stars { position:fixed; inset:0; z-index:-3; pointer-events:none; opacity:0; transition:opacity 2.5s linear; }
  .star{ position:absolute; background:white; border-radius:50%; box-shadow:0 0 8px rgba(255,255,255,0.6); opacity:0; animation:twinkle 3.5s infinite ease-in-out; }
  @keyframes twinkle { 0%,100%{opacity:0.05; transform:scale(1);} 50%{opacity:1; transform:scale(1.18);} }

  /* ========== ORB (sun/moon) + TRAIL CANVAS ========== */
  .orb-wrap { position:fixed; inset:0; z-index:-1; pointer-events:none; }
  .orb {
    position:absolute;
    width:86px; height:86px;
    border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    box-shadow: 0 12px 40px rgba(255,200,120,0.12), 0 0 70px rgba(255,200,120,0.06);
    transform: translate(-50%,-50%);
    transition: opacity 0.6s ease, transform 0.12s linear;
    will-change: transform, opacity;
  }
  .orb.sun {
    background: radial-gradient(circle at 30% 30%, #fff9d8 0%, #ffd88d 30%, #ffb04a 60%, #ff8a00 100%);
    box-shadow: 0 12px 50px rgba(255,165,60,0.28), 0 0 80px rgba(255,170,70,0.18);
  }
  .orb.moon {
    background: radial-gradient(circle at 35% 30%, #ffffff, #dfe7ff 30%, #b9c8ff 60%, #8d9cff 100%);
    box-shadow: 0 12px 40px rgba(120,150,255,0.12), 0 0 60px rgba(150,170,255,0.06) inset;
    filter: blur(.2px);
  }
  .orb .glow {
    position:absolute; inset:-26px; border-radius:50%; filter: blur(18px); opacity:.85; pointer-events:none;
  }
  .orb.sun .glow { background: radial-gradient(circle, rgba(255,185,80,0.22), rgba(255,140,0,0.06)); }
  .orb.moon .glow { background: radial-gradient(circle, rgba(180,200,255,0.13), rgba(120,150,255,0.03)); }

  /* ========== APP UI (big/bold) ========== */
  .app { position:relative; z-index:4; max-width:1250px; margin:36px auto; padding:28px; height: calc(100vh - 72px); display:flex; flex-direction: column; gap:22px; box-sizing:border-box; }
  header { display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); border-radius:22px; padding:20px 26px; border:1px solid rgba(255,255,255,0.06); backdrop-filter: blur(14px) saturate(120%); box-shadow:0 18px 60px rgba(6,10,18,0.35); }
  h1{ margin:0; font-size:1.6rem; font-weight:700; }
  .controls{ display:flex; gap:12px; align-items:center; }
  .btn{ background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); color:var(--text); border-radius:12px; padding:12px 14px; font-weight:600; border:1px solid rgba(255,255,255,0.06); cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
  .search-row { display:flex; gap:12px; margin-top:8px; align-items:center; }
  input[type="text"] { flex:1; font-size:1.05rem; padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.04); color:var(--text); outline:none; backdrop-filter: blur(8px); font-weight:600; }
  .main-grid { display:grid; grid-template-columns:1.8fr 1fr; gap:26px; align-items:start; flex:1; }
  .card{ background:var(--card-bg); border-radius:20px; padding:28px; border:1px solid rgba(255,255,255,0.06); backdrop-filter: blur(14px); box-shadow:0 18px 60px rgba(6,10,18,0.28); }
  .current{ display:flex; gap:28px; align-items:center; }
  lottie-player.icon{ width:170px; height:170px; flex-shrink:0; }
  .current-info{ display:flex; flex-direction:column; gap:6px; }
  .city{ font-size:1.35rem; font-weight:700; }
  .temp{ font-size:4.0rem; font-weight:800; line-height:0.9; }
  .desc{ font-size:1.05rem; font-weight:700; opacity:0.95; }
  .meta{ display:flex; flex-wrap:wrap; gap:14px; margin-top:16px; }
  .pill{ padding:12px 16px; border-radius:14px; font-weight:700; font-size:1.05rem; backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); min-width:150px; display:flex; justify-content:space-between; align-items:center; }
  .pill b{ font-weight:900; font-size:1.05rem; }
  .forecast h3{ margin:0 0 12px 0; font-size:1.15rem; font-weight:800; }
  .forecast canvas{ width:100% !important; height:220px !important; }
  footer{ text-align:center; margin-top:6px; color: rgba(255,255,255,0.75); font-weight:600; opacity:0.9; }

  @media (max-width:980px){ .main-grid{ grid-template-columns:1fr; } lottie-player.icon{ width:140px; height:140px; } .temp{ font-size:3.2rem; } .app{ padding:18px; } }
  @media (max-width:520px){ .temp{ font-size:2.6rem; } .pill{ min-width:120px; font-size:0.95rem; } }

</style>
</head>

<body>
  <!-- SKY + CLOUDS + STARS -->
  <div class="sky-wrap" aria-hidden="true">
    <div class="sky"></div>

    <div class="clouds" id="clouds">
      <div class="cloud c1"><img src="https://i.ibb.co/3chZpjD/cloud1.png" alt="cloud" style="width:100%"></div>
      <div class="cloud c2"><img src="https://i.ibb.co/0mS3Twr/cloud2.png" alt="cloud" style="width:100%"></div>
      <div class="cloud c3"><img src="https://i.ibb.co/xM8c5kP/cloud3.png" alt="cloud" style="width:100%"></div>
      <div class="cloud c1b"><img src="https://i.ibb.co/3chZpjD/cloud1.png" alt="cloud" style="width:100%"></div>
      <div class="cloud c2b"><img src="https://i.ibb.co/0mS3Twr/cloud2.png" alt="cloud" style="width:100%"></div>
    </div>

    <div class="stars" id="stars"></div>

    <!-- Orb + particle canvas -->
    <div class="orb-wrap" id="orbWrap">
      <canvas id="trailCanvas" style="position:absolute; inset:0; width:100%; height:100%; z-index:-1; pointer-events:none;"></canvas>
      <div id="orb" class="orb sun" style="left:50%; top:60%; opacity:0.98;">
        <div class="glow"></div>
      </div>
    </div>
  </div>

  <!-- APP UI -->
  <div class="app" role="application" aria-label="Premium weather dashboard">
    <header>
      <div>
        <h1>üå¶Ô∏è Weather </h1>
        <div class="search-row" style="margin-top:10px;">
          <input id="cityInput" type="text" placeholder="Enter city ‚Äî e.g., Delhi" />
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="searchBtn">üîé Search</button>
        <button class="btn" id="locBtn">üìç My Location</button>
        <button class="btn" id="themeBtn">üåó Theme</button>
      </div>
    </header>

    <div class="main-grid">
      <div class="card" id="currentWeather">
        <div class="current">
          <lottie-player id="lottieIcon" class="icon" autoplay loop></lottie-player>
          <div class="current-info">
            <div class="city" id="cityName">Delhi</div>
            <div class="temp" id="temp">--¬∞C</div>
            <div class="desc" id="desc">--</div>
            <div class="meta" aria-live="polite">
              <div class="pill">üí® Wind: <b id="wind">13.3 km/h</b></div>
              <div class="pill">üíß Humidity: <b id="humidity">28%</b></div>
              <div class="pill">‚òÄÔ∏è UV: <b id="uv">0.4</b></div>
              <div class="pill">üå´ AQI: <b id="aqi">4</b></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card forecast">
        <h3>3-Day Forecast</h3>
        <canvas id="forecastChart"></canvas>
      </div>
    </div>

    <footer>Powered by WeatherAPI</footer>
  </div>

<script>
/* ================= CONFIG ================= */
const API_KEY = "48028034d14346458a5130229251604";
const CYCLE_MS = 120000; // 1 minutes
const LOTTIES = {
  clear: "https://assets9.lottiefiles.com/packages/lf20_jbrw3hcz.json",
  cloudy: "https://assets10.lottiefiles.com/packages/lf20_kOfPKE.json",
  rain: "https://assets1.lottiefiles.com/packages/lf20_rpC1Rd.json",
  thunder: "https://assets9.lottiefiles.com/packages/lf20_jmBau.json",
  snow: "https://assets3.lottiefiles.com/packages/lf20_tkww4j0u.json",
  fog: "https://assets9.lottiefiles.com/packages/lf20_fvh9t7.json",
  default: "https://assets9.lottiefiles.com/packages/lf20_uk3trnkq.json"
};

/* ================= DOM REFS ================= */
const orb = document.getElementById('orb');
const trailCanvas = document.getElementById('trailCanvas');
const starsEl = document.getElementById('stars');
const cloudEls = document.querySelectorAll('.cloud');
const orbWrap = document.getElementById('orbWrap');
const themeBtn = document.getElementById('themeBtn');
const searchBtn = document.getElementById('searchBtn');
const locBtn = document.getElementById('locBtn');
const cityInput = document.getElementById('cityInput');
const lottieIcon = document.getElementById('lottieIcon');

let trailCtx;
let particlePool = [];
let particles = [];
let lastFrame = performance.now();
let chart = null;

/* ========== Canvas setup ========== */
function setupCanvas(){
  trailCanvas.width = window.innerWidth * devicePixelRatio;
  trailCanvas.height = window.innerHeight * devicePixelRatio;
  trailCanvas.style.width = window.innerWidth + 'px';
  trailCanvas.style.height = window.innerHeight + 'px';
  trailCtx = trailCanvas.getContext('2d');
  trailCtx.scale(devicePixelRatio, devicePixelRatio);
  trailCtx.globalCompositeOperation = 'lighter';
}
setupCanvas();
window.addEventListener('resize', () => { setupCanvas(); });

/* ========== Orb positioning along arc ========== */
/*
  We compute an angle from t (0..1) so orb moves left -> top -> right across the sky:
  angle = PI * (1 - t)  => t=0 => angle=PI (left), t=0.5 => angle=PI/2 (top), t=1 => angle=0 (right)
  Then position:
  center = (cx, cy) where cx = innerWidth/2, cy = window.innerHeight * 0.46 (slightly above center)
  radius = min(cx*0.95, window.innerHeight*0.65)
*/
function getOrbPosition(t){
  const w = window.innerWidth;
  const h = window.innerHeight;
  const cx = w/2;
  const cy = h * 0.46;
  const radius = Math.min(cx * 0.95, h * 0.7);
  const angle = Math.PI * (1 - t); // left -> top -> right
  const x = cx + radius * Math.cos(angle);
  const y = cy - radius * Math.sin(angle) * 0.86; // flatten arc slightly
  return { x, y };
}

/* ========== Particle system (luminous spark trail) ========== */
function spawnParticle(x,y, color){
  const p = particlePool.length ? particlePool.pop() : {};
  p.x = x + (Math.random()*10 - 5);
  p.y = y + (Math.random()*6 - 3);
  p.vx = (Math.random()*1 - 0.5) * 0.25;
  p.vy = - (Math.random()*0.6 + 0.2);
  p.life = 700 + Math.random()*600; // ms
  p.age = 0;
  p.size = 1 + Math.random()*3;
  p.color = color;
  particles.push(p);
}

function updateParticles(dt){
  // spawn rate depends on whether orb is visible (sun/day) or moon: more visible -> more particles
  // but we'll spawn a baseline of 3 particles per frame when moving
  const spawnCount = 3;
  for(let i=0;i<spawnCount;i++){
    // spawn at last orbPos (global)
    if(lastOrbPos) spawnParticle(lastOrbPos.x + (Math.random()*8 -4), lastOrbPos.y + (Math.random()*5 -2), lastOrbColor);
  }

  // update and draw
  trailCtx.clearRect(0,0,trailCanvas.width, trailCanvas.height);
  // scale already set, so draw in CSS pixel coords
  particles = particles.filter(p => {
    p.age += dt;
    const lifeRatio = 1 - (p.age / p.life);
    if(lifeRatio <= 0){
      particlePool.push(p);
      return false;
    }
    p.x += p.vx * (dt/16);
    p.y += p.vy * (dt/16);
    // draw glow circle
    const g = trailCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size*8);
    const rgba = hexToRGBA(p.color, 0.18 * lifeRatio);
    g.addColorStop(0, hexToRGBA(p.color, 0.95 * lifeRatio));
    g.addColorStop(0.35, hexToRGBA(p.color, 0.35 * lifeRatio));
    g.addColorStop(1, hexToRGBA(p.color, 0.0));
    trailCtx.beginPath();
    trailCtx.fillStyle = g;
    trailCtx.arc(p.x, p.y, p.size*8, 0, Math.PI*2);
    trailCtx.fill();

    // small bright core
    trailCtx.beginPath();
    trailCtx.fillStyle = hexToRGBA(p.color, 0.9 * lifeRatio);
    trailCtx.arc(p.x, p.y, Math.max(1, p.size * 0.6), 0, Math.PI*2);
    trailCtx.fill();

    return true;
  });
}

function hexToRGBA(hex, alpha){
  // accept "#rrggbb" or "rgb(...)" or hex-like; but we'll handle common hex
  if(typeof hex !== 'string') return `rgba(255,255,255,${alpha})`;
  if(hex.startsWith('#')){
    const h = hex.slice(1);
    const r = parseInt(h.substring(0,2),16);
    const g = parseInt(h.substring(2,4),16);
    const b = parseInt(h.substring(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  return `rgba(255,255,255,${alpha})`;
}

/* ========== Stars creation ========== */
function createStars(count=140){
  starsEl.innerHTML = "";
  for(let i=0;i<count;i++){
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random()*2.6 + 0.6;
    s.style.width = size + 'px';
    s.style.height = size + 'px';
    s.style.top = (Math.random()*100) + '%';
    s.style.left = (Math.random()*100) + '%';
    s.style.animationDuration = (2 + Math.random()*3.5) + 's';
    s.style.animationDelay = (Math.random()*4) + 's';
    starsEl.appendChild(s);
  }
}
createStars(140);

/* ========== Visual sync loop ========== */
let lastOrbPos = null;
let lastOrbColor = '#ffd88d';

function visualLoop(now){
  const dt = now - lastFrame;
  lastFrame = now;
  const t = ((now % CYCLE_MS) / CYCLE_MS); // 0..1
  // orb position along arc: left -> top -> right
  const pos = getOrbPosition(t);
  lastOrbPos = pos;

  // star opacity: visible at night windows (matching previous logic)
  let starOpacity = 0;
  if(t < 0.12 || t > 0.88) starOpacity = 1.0;
  else if(t >= 0.75 && t <= 0.88) starOpacity = (0.88 - t) / 0.13;
  else if(t >= 0.12 && t <= 0.25) starOpacity = Math.max(0, (0.25 - t)/0.13);
  else starOpacity = 0;
  starsEl.style.opacity = String(starOpacity);

  // determine whether to show sun or moon (and pick color)
  // sun is most visible between 0.12 and 0.88 (~day+sunrise+sunset), moon otherwise
  const sunVisible = (t >= 0.12 && t <= 0.88);
  if(sunVisible){
    orb.classList.remove('moon');
    orb.classList.add('sun');
    lastOrbColor = '#ffd88d'; // warm gold for particles
  } else {
    orb.classList.remove('sun');
    orb.classList.add('moon');
    lastOrbColor = '#dfe7ff'; // cool pale for moon particles
  }

  // position orb (centered by translate(-50%,-50%))
  orb.style.left = `${pos.x}px`;
  orb.style.top = `${pos.y}px`;
  // subtle scale depending on height (bigger near top)
  const hFactor = 1 - Math.abs((pos.y / window.innerHeight) - 0.3); // arbitrary shaping
  const scale = 0.9 + Math.max(0, hFactor) * 0.25;
  orb.style.transform = `translate(-50%,-50%) scale(${scale})`;

  // spawn particles and update/draw them
  updateParticles(dt);

  // apply cloud warm tint at sunrise/sunset by adjusting filter/hue-rotate
  // compute warmth factor based on proximity to sunrise (0.20-0.30) and sunset (0.75-0.85)
  let warmth = 0;
  if(t >= 0.20 && t <= 0.30) { warmth = Math.sin(((t - 0.20) / 0.10) * Math.PI); }
  else if(t >= 0.75 && t <= 0.85) { warmth = Math.sin(((t - 0.75) / 0.10) * Math.PI); }
  cloudEls.forEach((el, idx) => {
    const baseBoost = (idx % 2 === 0) ? 0.10 : 0.06;
    const warmthBoost = warmth * (0.4 + baseBoost);
    // combine filters
    const hue = warmth * 12;
    el.style.filter = `brightness(${1 + warmthBoost}) saturate(${1 + warmthBoost * 0.6}) hue-rotate(${hue}deg)`;
  });

  requestAnimationFrame(visualLoop);
}
// kick loop
requestAnimationFrame(visualLoop);

/* ========== Helpers: Lottie picker & UI render ========== */
function pickLottie(condition){
  const c = (condition || "").toLowerCase();
  if(c.includes("sun") || c.includes("clear")) return LOTTIES.clear;
  if(c.includes("cloud")) return LOTTIES.cloudy;
  if(c.includes("rain") || c.includes("drizzle")) return LOTTIES.rain;
  if(c.includes("thunder")) return LOTTIES.thunder;
  if(c.includes("snow") || c.includes("sleet")) return LOTTIES.snow;
  if(c.includes("fog") || c.includes("mist") || c.includes("haze")) return LOTTIES.fog;
  return LOTTIES.default;
}

function renderWeather(data){
  try{
    const c = data.current;
    const loc = data.location;
    document.getElementById('cityName').textContent = `${loc.name}, ${loc.country || ''}`;
    document.getElementById('temp').textContent = `${Math.round(c.temp_c)}¬∞C`;
    document.getElementById('desc').textContent = c.condition.text || '--';
    document.getElementById('wind').textContent = `${(c.wind_kph || 0).toFixed(1)} km/h`;
    document.getElementById('humidity').textContent = `${(c.humidity || '--')}%`;
    document.getElementById('uv').textContent = (c.uv != null ? c.uv : '--');
    let aqi = '--';
    try { aqi = data.current.air_quality ? data.current.air_quality["us-epa-index"] : '--'; } catch(e){}
    document.getElementById('aqi').textContent = aqi;
    const lottieUrl = pickLottie(c.condition.text || '');
    lottieIcon.setAttribute('src', lottieUrl);

    const days = data.forecast.forecastday.map(d => d.date);
    const max = data.forecast.forecastday.map(d => d.day.maxtemp_c);
    const min = data.forecast.forecastday.map(d => d.day.mintemp_c);
    const ctx = document.getElementById('forecastChart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'line',
      data: {
        labels: days,
        datasets:[
          { label:'Max ¬∞C', data: max, borderColor:'#ffb86b', backgroundColor:'rgba(255,184,107,0.06)', fill:true, tension:0.38, pointRadius:6 },
          { label:'Min ¬∞C', data: min, borderColor:'#6bd4ff', backgroundColor:'rgba(107,212,255,0.03)', fill:true, tension:0.38, pointRadius:6 }
        ]
      },
      options: {
        animations: { tension: { duration: 600, easing: 'linear' } },
        plugins: { legend:{ labels:{ color: getComputedStyle(document.body).color } } },
        scales: { x:{ ticks:{ color: getComputedStyle(document.body).color } }, y:{ ticks:{ color: getComputedStyle(document.body).color } } }
      }
    });
  } catch(e){ console.error('renderWeather error', e); }
}

/* ========== Fetch weather ========== */
async function fetchWeather(q){
  try {
    const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(q)}&days=3&aqi=yes&alerts=no`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Network response not ok');
    const data = await res.json();
    renderWeather(data);
  } catch(err){
    console.warn('Weather fetch failed', err);
  }
}

/* ========== UI wiring & defaults ========== */
document.getElementById('wind').textContent = "13.3 km/h";
document.getElementById('humidity').textContent = "28%";
document.getElementById('uv').textContent = "0.4";
document.getElementById('aqi').textContent = "4";
document.getElementById('cityName').textContent = "";
document.getElementById('temp').textContent = "--¬∞C";
document.getElementById('desc').textContent = "Loading...";

searchBtn.onclick = () => { const city = cityInput.value.trim(); if(city) fetchWeather(city); };
cityInput.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ searchBtn.click(); } });
locBtn.onclick = () => {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos => {
      fetchWeather(`${pos.coords.latitude},${pos.coords.longitude}`);
    }, err => { console.warn('Geolocation failed', err); });
  } else alert('Geolocation not supported in this browser.');
};

themeBtn.onclick = () => {
  const cur = document.documentElement.dataset.theme;
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
  // stars visible in dark
  document.getElementById('stars').style.opacity = next === 'dark' ? '1' : '0';
};

/* ========== Kickoff ========== */
fetchWeather('');

/* Ensure canvas uses CSS pixel coordinates for drawing (we used scaling earlier in setup) */
(function ensureCanvasSetup(){
  // ensure initial pixel ratio scaling is applied
  setupCanvas();
})();
</script>
</body>
</html>

